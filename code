// ==UserScript==
// @name         ネクストレベル自動設定スクリプト v1.1
// @namespace    https://www.e-nextlevel.jp/
// @version      1.1
// @description  軽作業・催事・スキマバイト + 東京都 + エントリー可否の強制設定と変更ログ出力機能付きスクリプト
// @author       You
// @match        https://www.e-nextlevel.jp/work/search*
// @grant        none
// ==/UserScript==

(function () {
  'use strict';

  const TARGET_JOB_LABELS = ['軽作業', '催事・イベント・展示会'];
  const TARGET_RADIO_LABEL = 'スキマバイト';
  const PREF_TARGET = '東京都';

  function logChange(label, oldValue, newValue) {
    if (oldValue !== newValue) {
      console.log(`[変更検知] ${label}: ${oldValue} → ${newValue}`);
    }
  }

  function forceSelectOptions() {
    // 職種チェック
    const jobLabels = document.querySelectorAll('label.sideModalForm__checkbox');
    jobLabels.forEach((label) => {
      const text = label.querySelector('span.sideModalForm__checkboxText')?.textContent.trim();
      const checkbox = label.querySelector('input[type="checkbox"]');
      if (!checkbox) return;

      const shouldCheck = TARGET_JOB_LABELS.includes(text);
      if (shouldCheck && !checkbox.checked) {
        logChange(`職種: ${text}`, '未選択', '選択');
        checkbox.checked = true;
        checkbox.dispatchEvent(new Event('change', { bubbles: true }));
      }
    });

    // 勤務形態（ラジオボタン）
    const radioLabels = document.querySelectorAll('label.sideModalForm__radio');
    radioLabels.forEach((label) => {
      const text = label.querySelector('span.sideModalForm__radioText')?.textContent.trim();
      const radio = label.querySelector('input[type="radio"]');
      if (!radio) return;

      if (text === TARGET_RADIO_LABEL && !radio.checked) {
        logChange(`勤務形態: ${text}`, '未選択', '選択');
        radio.checked = true;
        radio.dispatchEvent(new Event('change', { bubbles: true }));
      }
    });

    // 都道府県
    jobLabels.forEach((label) => {
      const text = label.querySelector('span.sideModalForm__checkboxText')?.textContent.trim();
      const checkbox = label.querySelector('input[type="checkbox"]');
      if (!checkbox) return;

      if (text === PREF_TARGET) {
        if (!checkbox.checked) {
          logChange(`都道府県: ${text}`, '未選択', '選択');
          checkbox.checked = true;
          checkbox.dispatchEvent(new Event('change', { bubbles: true }));
        }
      } else {
        if (checkbox.checked) {
          logChange(`都道府県: ${text}`, '選択', '未選択');
          checkbox.checked = false;
          checkbox.dispatchEvent(new Event('change', { bubbles: true }));
        }
      }
    });

    // エントリー可否ボタン
    const entryBtn = document.querySelector('#narrowingDown');
    if (entryBtn) {
      const currentText = entryBtn.textContent.trim();
      const isChecked = entryBtn.classList.contains('is_checked');
      if (currentText !== 'エントリー可' || !isChecked) {
        logChange('エントリー可否ボタン', currentText + (isChecked ? ' (✓)' : ' (✗)'), 'エントリー可 (✓)');
        entryBtn.textContent = 'エントリー可';
        entryBtn.classList.add('is_checked');
      }
    }
  }

  function addManualButton() {
    const btn = document.createElement('button');
    btn.innerText = '🔧 一括自動設定';
    btn.style.position = 'fixed';
    btn.style.top = '10px';
    btn.style.right = '10px';
    btn.style.zIndex = 10000;
    btn.style.padding = '8px 14px';
    btn.style.backgroundColor = '#0069d9';
    btn.style.color = '#fff';
    btn.style.border = 'none';
    btn.style.borderRadius = '4px';
    btn.style.cursor = 'pointer';

    btn.addEventListener('click', () => {
      forceSelectOptions();
      alert('自動設定を実行しました（コンソールログも確認してください）。');
    });

    document.body.appendChild(btn);
  }

  function initWhenReady() {
    const observer = new MutationObserver(() => {
      const hasJobs = document.querySelector('label.sideModalForm__checkbox');
      const hasRadios = document.querySelector('label.sideModalForm__radio');
      const hasEntryBtn = document.querySelector('#narrowingDown');
      if (hasJobs && hasRadios && hasEntryBtn) {
        forceSelectOptions();
        addManualButton();
        observer.disconnect();
      }
    });

    observer.observe(document.body, { childList: true, subtree: true });
  }

  window.addEventListener('load', initWhenReady);
})();
